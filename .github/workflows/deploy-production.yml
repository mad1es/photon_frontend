name: Deploy Frontend Production Environment (Main Branch)

on:
  push:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    
    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v3
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        version: 1.82.0
        timeout: 1m
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 22 -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy
      run: |
        ssh -p 22 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        REPO_DIR=~/photon-frontend
        REPO_URL=https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
        
        # Use git pull instead of clone if directory exists
        if [ -d "$REPO_DIR" ]; then
          echo "Updating existing repository..."
          cd "$REPO_DIR"
          git fetch origin
          git reset --hard origin/main
          git clean -fd
        else
          echo "Cloning repository..."
          git clone -b main "$REPO_URL" "$REPO_DIR"
          cd "$REPO_DIR"
        fi
        
        # Stop existing container
        docker stop photon-frontend 2>/dev/null || true
        docker rm photon-frontend 2>/dev/null || true
        
        # Create network if not exists
        docker network create bizdin-network 2>/dev/null || true
        
        # Create .env file if it doesn't exist
        if [ ! -f .env ]; then
          echo "NODE_ENV=production" > .env
          echo "PORT=3001" >> .env
        fi
        
        # Build with BuildKit cache and run
        export DOCKER_BUILDKIT=1
        export COMPOSE_DOCKER_CLI_BUILD=1
        PORT=3001 docker compose -f docker-compose.prod.yml build --parallel
        PORT=3001 docker compose -f docker-compose.prod.yml up -d
        
        # Wait for container to be ready
        sleep 5
        docker ps | grep photon-frontend || (docker ps && exit 1)
        
        EOF
        
    - name: Setup Nginx
      run: |
        ssh -p 22 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        cat > ~/photon-frontend.conf << 'NGINXEOF'
        server {
            listen 8017;
            server_name _;
            location / {
                proxy_pass http://localhost:3001;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        NGINXEOF
        
        if sudo -n cp ~/photon-frontend.conf /etc/nginx/sites-available/photon-frontend 2>/dev/null; then
          sudo ln -sf /etc/nginx/sites-available/photon-frontend /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx
        fi
        EOF
        
    - name: Verify Deployment
      run: |
        ssh -p 22 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        if docker ps | grep -q photon-frontend; then
          echo "Deployment successful"
        else
          echo "Container not running"
          docker ps
          exit 1
        fi
        EOF
