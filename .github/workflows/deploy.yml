name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 194.32.142.37 >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@194.32.142.37 bash << EOF
            set -e
            
            # Создаем директорию если не существует
            mkdir -p ~/photon-frontend
            cd ~/photon-frontend
            
            # Проверяем, является ли директория git репозиторием
            if [ ! -d .git ]; then
              echo "Repository not found. Cloning..."
              cd ~
              rm -rf photon-frontend
              git clone "${REPO_URL}" photon-frontend
              cd photon-frontend
            else
              echo "Pulling latest code..."
              git fetch origin
              git reset --hard origin/main
            fi
            
            echo "Stopping old container..."
            docker compose down || true
            
            echo "Checking system resources..."
            free -h
            df -h
            
            echo "Building new image (this may take 5-10 minutes)..."
            timeout 1800 DOCKER_BUILDKIT=1 docker compose build --progress=plain --no-cache || {
              echo "Build failed or timed out. Checking logs..."
              docker compose logs || true
              echo "System resources after failed build:"
              free -h
              exit 1
            }
            
            echo "Starting container..."
            docker compose up -d
            
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Checking container status..."
            sleep 5
            docker compose ps
            
            echo "Deployment completed successfully!"
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
